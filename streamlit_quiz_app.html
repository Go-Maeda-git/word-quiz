<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .app-container {
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
            text-align: center;
        }
        h1, h2, h3 {
            color: #1d3557; /* ã‚ˆã‚Šæ¿ƒã„é’ */
            margin-bottom: 15px;
        }
        .quiz-selection button, .options button, .action-button {
            background-color: #457b9d; /* ãƒ¡ã‚¤ãƒ³ã®é’ */
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }
        .quiz-selection button:hover, .options button:hover, .action-button:hover {
            background-color: #1d3557; /* ãƒ›ãƒãƒ¼æ™‚ã®æ¿ƒã„é’ */
            transform: translateY(-1px);
        }
        .quiz-selection button { width: calc(50% - 10px); }

        #question-area .question-text {
            font-size: 1.1em;
            margin-bottom: 20px;
            text-align: left;
            line-height: 1.6;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #457b9d;
        }
        #question-area .question-text .blank {
            font-weight: bold;
            color: #e63946; /* ç›®ç«‹ã¤èµ¤è‰² */
            display: inline-block;
            min-width: 60px;
            text-align: center;
            border-bottom: 2px dotted #e63946;
        }
        .options { margin-bottom: 20px; }
        .options button { display: block; width: 100%; text-align: left; margin-bottom: 8px; background-color: #a8dadc; color: #1d3557;}
        .options button:hover { background-color: #f1faee; color: #1d3557; }
        .options button.selected { background-color: #1d3557; color: white; }


        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-size: 1.1em;
            text-align: left;
        }
        .feedback.correct { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;}
        .feedback.incorrect { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7;}

        .explanation, .examples, .note, .mistake-analysis {
            text-align: left;
            margin-top: 15px;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            color: #0c5460;
            border: 1px solid #bee5eb;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .explanation ul, .examples ul, .mistake-analysis ul { list-style-type: "âœ“ "; padding-left: 20px; margin: 5px 0; }
        .mistake-analysis li { margin-bottom: 8px; }
        .mistake-analysis .mistake-q { font-weight: bold; }
        .mistake-analysis .mistake-correct { color: green; }
        .mistake-analysis .mistake-explanation { font-size: 0.9em; color: #555; margin-left: 15px; }


        hr { border: 0; height: 1px; background: #ced4da; margin: 25px 0; }
        .score-display { font-size: 1.2em; margin-bottom: 15px; color: #1d3557;}

        /* Hide elements initially */
        #quiz-area, #results-area { display: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="quiz-selection-area">
            <h1>è‹±èªã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</h1>
            <p>æŒ‘æˆ¦ã™ã‚‹ã‚¯ã‚¤ã‚ºã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            <div class="quiz-selection">
                <button onclick="selectQuizType('suffix')">èªå°¾ã§å“è©ã‚¯ã‚¤ã‚º</button>
                <button onclick="selectQuizType('conjPrep')">å‰ç½®è©ãƒ»æ¥ç¶šè©ã‚¯ã‚¤ã‚º</button>
            </div>
        </div>

        <div id="quiz-area">
            <h2 id="quiz-title"></h2>
            <p id="quiz-instruction"></p>
            <hr>
            <div id="question-display">
                <p class="question-info" id="question-count"></p>
                <!-- èªå°¾ã‚¯ã‚¤ã‚ºç”¨ -->
                <h2 id="suffix-display" style="display:none;"></h2>
                <p id="suffix-note-display" style="text-align: center; color: #FF6347; display:none;"></p>
                <!-- å‰ç½®è©ãƒ»æ¥ç¶šè©ã‚¯ã‚¤ã‚ºç”¨ -->
                <div id="conj-prep-question-text" class="question-text" style="display:none;"></div>
                <hr>
                <div class="options" id="options-buttons"></div>
            </div>

            <div id="feedback-area" class="feedback" style="display:none;">
                <p id="feedback-text"></p>
                <div id="details-container" style="display:none;">
                    <!-- èªå°¾ã‚¯ã‚¤ã‚ºç”¨è©³ç´° -->
                    <div id="suffix-details">
                        <div id="examples-container" class="examples" style="display:none;">
                            <strong>å˜èªä¾‹:</strong> <ul id="example-list"></ul>
                        </div>
                        <div id="note-container" class="note" style="display:none;">
                            ğŸ“ <strong>è£œè¶³:</strong> <span id="note-text"></span>
                        </div>
                    </div>
                    <!-- å‰ç½®è©ãƒ»æ¥ç¶šè©ã‚¯ã‚¤ã‚ºç”¨è©³ç´° -->
                    <div id="conj-prep-details">
                        <div id="explanation-container" class="explanation" style="display:none;">
                            ğŸ’¡ <strong>è§£èª¬:</strong> <span id="explanation-text"></span>
                        </div>
                    </div>
                </div>
            </div>
            <button id="next-question-button" class="action-button" style="display:none;">æ¬¡ã®å•é¡Œã¸</button>
        </div>

        <div id="results-area">
            <h2>ğŸ‰ ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼ ğŸ‰</h2>
            <h3>ã‚ãªãŸã®æˆç¸¾:</h3>
            <p class="score-display" id="final-score"></p>
            <p class="score-display" id="total-questions"></p>
            <p class="score-display" id="accuracy"></p>
            <hr>
            <div id="mistake-analysis-area" class="mistake-analysis" style="display:none;">
                <h3>é–“é•ãˆãŸå•é¡Œã®å‚¾å‘ã¨å¯¾ç­–</h3>
                <div id="mistake-summary"></div>
                <h4>é–“é•ãˆãŸå•é¡Œãƒªã‚¹ãƒˆ:</h4>
                <ul id="mistake-list"></ul>
                <h4>å¯¾ç­–ã‚³ãƒ¡ãƒ³ãƒˆ:</h4>
                <p id="countermeasure-comment"></p>
            </div>
            <hr>
            <button id="retry-quiz-button" class="action-button">ã‚‚ã†ä¸€åº¦åŒã˜ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦</button>
            <button onclick="showQuizSelection()" class="action-button">ä»–ã®ã‚¯ã‚¤ã‚ºã‚’é¸ã¶</button>
        </div>
    </div>

    <script>
        // --- èªå°¾å“è©ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ (æ—¢å­˜) ---
        const suffixDataList = [
            {"suffix": "-ance", "pos": "åè©", "examples": ["performance (å…¬æ¼”)", "maintenance (ä¿å®ˆç‚¹æ¤œ)", "distance (è·é›¢)"], "note": null},
            {"suffix": "-cy", "pos": "åè©", "examples": ["policy (æ–¹é‡)", "emergency (ç·Šæ€¥äº‹æ…‹)", "agency (ä»£ç†åº—)"], "note": null},
            {"suffix": "-ly (ä¾‹å¤–)", "pos": "å½¢å®¹è©", "examples": ["friendly (è¦ªåˆ‡ãª)", "costly (è²»ç”¨ã®ã‹ã‹ã‚‹)"], "note": "ã“ã‚Œã‚‰ã¯åè©ã« -ly ãŒã¤ã„ã¦å½¢å®¹è©ã«ãªã£ãŸä¾‹ã§ã™ã€‚"},
            // ... (ä»–ã®èªå°¾ãƒ‡ãƒ¼ã‚¿ã‚‚ã“ã“ã«è¿½åŠ )
        ];

        // --- å‰ç½®è©ãƒ»æ¥ç¶šè©ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ (æ–°è¦è¿½åŠ ) ---
        const conjunctionPrepositionData = [
            {
                id: 1,
                questionParts: ["Currently, the Tokyo Central Bank has overseas branches in the UK, Hong Kong, ", " China."], // ç©ºæ¬„ã‚’æŒŸã‚€å½¢ã§åˆ†å‰²
                options: { A: "and", B: "if", C: "such", D: "but" },
                answer: "A",
                correctWord: "and",
                wordType: "æ¥ç¶šè©", // ç©ºæ¬„ã«å…¥ã‚‹å˜èªã®å“è©
                explanation: "ç©ºæ‰€ã«ç­‰ä½æ¥ç¶šè© (A) and ã‚’è£œã†ã¨ã€UK, Hong Kong, and China ã®ã‚ˆã†ã«3ã¤ãŒä¸¦åˆ—ã•ã‚Œã¾ã™ã€‚æ–‡è„ˆã«åˆè‡´ã—ã¾ã™ã€‚"
            },
            {
                id: 2,
                questionParts: ["Apple Hills residents are encouraged to renew their driver's licenses online ", " they have already expired."],
                options: { A: "whether", B: "so", C: "unless", D: "due to" },
                answer: "C",
                correctWord: "unless",
                wordType: "æ¥ç¶šè©",
                explanation: "(C) unlessã€Œã€œã§ãªã„é™ã‚Šã€ãŒé©åˆ‡ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§æ›´æ–°ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã‚‹ã®ã¯ã€å…è¨±ãŒæ—¢ã«å¤±åŠ¹ã—ã¦ã„ãªã„é™ã‚Šã€ã¨ã„ã†æ„å‘³ã«ãªã‚Šã¾ã™ã€‚"
            },
            {
                id: 3,
                questionParts: ["Jackets are required for club members in the main dining room ", " casual dress is acceptable in all other areas of the club."],
                options: { A: "during", B: "what", C: "such", D: "while" },
                answer: "D",
                correctWord: "while",
                wordType: "æ¥ç¶šè©",
                explanation: "(D) whileã€Œï½ã§ã‚ã‚‹ä¸€æ–¹ã€ãŒé©åˆ‡ã€‚ãƒ¡ã‚¤ãƒ³ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ã§ã¯ã‚¸ãƒ£ã‚±ãƒƒãƒˆãŒå¿…è¦ã ãŒã€ä»–ã®ã‚¨ãƒªã‚¢ã§ã¯ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªæœè£…ã§ã‚‚è‰¯ã„ã€ã¨ã„ã†å¯¾æ¯”ã‚’è¡¨ã—ã¾ã™ã€‚"
            },
            {
                id: 4,
                questionParts: ["", " she has already proved herself a versatile actress, Helen Kuroshima continues to study to develop her acting style."],
                options: { A: "Not only", B: "Although", C: "Despite", D: "Consequently" },
                answer: "B",
                correctWord: "Although",
                wordType: "æ¥ç¶šè©",
                explanation: "(B) Althoughã€Œã€œã ã‘ã‚Œã©ã‚‚ã€ãŒé©åˆ‡ã€‚æ—¢ã«å¤šæ‰ãªå¥³å„ªã§ã‚ã‚‹ã“ã¨ã‚’è¨¼æ˜ã—ã¦ã„ã‚‹ãŒã€ã•ã‚‰ã«æ¼”æŠ€ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç™ºå±•ã•ã›ã‚‹ãŸã‚ã«å‹‰å¼·ã‚’ç¶šã‘ã¦ã„ã‚‹ã€ã¨ã„ã†è­²æ­©ã®é–¢ä¿‚ã§ã™ã€‚"
            },
            {
                id: 5,
                questionParts: ["With the exception of a few pavilions, all are slated for removal or demolition ", " the trade show closes on October 31."],
                options: { A: "after", B: "either", C: "due to", D: "during" },
                answer: "A",
                correctWord: "after",
                wordType: "æ¥ç¶šè©", // ã‚‚ã—ãã¯å‰ç½®è©ã ãŒã€ã“ã“ã§ã¯ç¯€ã‚’å°ã„ã¦ã„ã‚‹ã®ã§æ¥ç¶šè©çš„
                explanation: "(A) afterã€Œã€œã®å¾Œã§ã€ãŒé©åˆ‡ã€‚ã„ãã¤ã‹ã®ãƒ‘ãƒ“ãƒªã‚ªãƒ³ã‚’é™¤ãã€å…¨ã¦ãŒ10æœˆ31æ—¥ã«å±•ç¤ºä¼šãŒé–‰å¹•ã—ãŸå¾Œã«æ’¤å»ã¾ãŸã¯è§£ä½“ã•ã‚Œã‚‹äºˆå®šã€ã¨ã„ã†æ„å‘³ã«ãªã‚Šã¾ã™ã€‚"
            }
            // --- ã“ã“ã«ä»–ã®å•é¡Œã‚’è¿½åŠ  ---
            // å•é¡Œ56ã®ä¾‹
            // {
            //     id: 56,
            //     questionParts: ["", " retiring from Smith Computer Technologies two years ago, Bill Smith has been devoting more time to charity events."],
            //     options: { A: "When", B: "Since", C: "Already", D: "From" },
            //     answer: "B",
            //     correctWord: "Since",
            //     wordType: "æ¥ç¶šè©",
            //     explanation: "ç©ºæ¬„ã‹ã‚‰ã‚«ãƒ³ãƒã¾ã§ãŒåˆ†è©æ§‹æ–‡ã®ã‚«ã‚¿ãƒãƒªã€‚æ­£è§£ã¯(B)Sinceã€Œã€œä»¥æ¥ã€ã€‚æ¥ç¶šè©ã®Sinceã¯ã€Œã€œãªã®ã§ã€ã®æ„å‘³ã‚‚ã‚ã‚‹ãŒã€ã“ã“ã§ã¯ã€Œã€œä»¥æ¥ã€ã§æ™‚ã‚’è¡¨ã™ã€‚Smith Computer Technologiesã‚’2å¹´å‰ã«é€€è·ã—ã¦ä»¥æ¥ã€ãƒ“ãƒ«ãƒ»ã‚¹ãƒŸã‚¹ã¯æ…ˆå–„ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã‚Šå¤šãã®æ™‚é–“ã‚’æ§ã’ã¦ã„ã‚‹ã€‚"
            // },
        ];

        let currentQuizType = ''; // 'suffix' or 'conjPrep'
        let currentQuestionData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectAnswers = []; // é–“é•ãˆãŸå•é¡Œã‚’è¨˜éŒ²

        // DOM Elements
        const quizSelectionAreaEl = document.getElementById('quiz-selection-area');
        const quizAreaEl = document.getElementById('quiz-area');
        const resultsAreaEl = document.getElementById('results-area');
        const quizTitleEl = document.getElementById('quiz-title');
        const quizInstructionEl = document.getElementById('quiz-instruction');

        const questionCountEl = document.getElementById('question-count');
        const suffixDisplayEl = document.getElementById('suffix-display');
        const suffixNoteDisplayEl = document.getElementById('suffix-note-display');
        const conjPrepQuestionTextEl = document.getElementById('conj-prep-question-text');
        const optionsButtonsEl = document.getElementById('options-buttons');

        const feedbackAreaEl = document.getElementById('feedback-area');
        const feedbackTextEl = document.getElementById('feedback-text');
        const detailsContainerEl = document.getElementById('details-container');
        const suffixDetailsEl = document.getElementById('suffix-details');
        const conjPrepDetailsEl = document.getElementById('conj-prep-details');
        const exampleListEl = document.getElementById('example-list');
        const noteContainerEl = document.getElementById('note-container');
        const noteTextEl = document.getElementById('note-text');
        const explanationContainerEl = document.getElementById('explanation-container');
        const explanationTextEl = document.getElementById('explanation-text');

        const nextQuestionButtonEl = document.getElementById('next-question-button');
        const finalScoreEl = document.getElementById('final-score');
        const totalQuestionsEl = document.getElementById('total-questions');
        const accuracyEl = document.getElementById('accuracy');
        const retryQuizButtonEl = document.getElementById('retry-quiz-button');

        const mistakeAnalysisAreaEl = document.getElementById('mistake-analysis-area');
        const mistakeSummaryEl = document.getElementById('mistake-summary');
        const mistakeListEl = document.getElementById('mistake-list');
        const countermeasureCommentEl = document.getElementById('countermeasure-comment');


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function selectQuizType(type) {
            currentQuizType = type;
            quizSelectionAreaEl.style.display = 'none';
            quizAreaEl.style.display = 'block';
            resultsAreaEl.style.display = 'none';
            mistakeAnalysisAreaEl.style.display = 'none';
            startQuiz();
        }

        function showQuizSelection() {
            quizSelectionAreaEl.style.display = 'block';
            quizAreaEl.style.display = 'none';
            resultsAreaEl.style.display = 'none';
        }

        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            incorrectAnswers = [];
            optionsButtonsEl.innerHTML = ''; // Clear previous buttons
            feedbackAreaEl.style.display = 'none';
            nextQuestionButtonEl.style.display = 'none';
            detailsContainerEl.style.display = 'none';


            if (currentQuizType === 'suffix') {
                quizTitleEl.textContent = 'èªå°¾ã§å“è©ã‚¯ã‚¤ã‚º';
                quizInstructionEl.textContent = 'è¡¨ç¤ºã•ã‚ŒãŸèªå°¾ãŒã€ä¸»ã«ã©ã®å“è©ã§ä½¿ã‚ã‚Œã‚‹ã‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
                currentQuestionData = shuffleArray([...suffixDataList]);
                suffixDisplayEl.style.display = 'block';
                suffixNoteDisplayEl.style.display = 'block';
                conjPrepQuestionTextEl.style.display = 'none';
            } else if (currentQuizType === 'conjPrep') {
                quizTitleEl.textContent = 'å‰ç½®è©ãƒ»æ¥ç¶šè©ã‚¯ã‚¤ã‚º';
                quizInstructionEl.textContent = 'ç©ºæ¬„ã«æœ€ã‚‚é©åˆ‡ãªèªå¥ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
                currentQuestionData = shuffleArray([...conjunctionPrepositionData]);
                suffixDisplayEl.style.display = 'none';
                suffixNoteDisplayEl.style.display = 'none';
                conjPrepQuestionTextEl.style.display = 'block';
            }
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex < currentQuestionData.length) {
                const questionData = currentQuestionData[currentQuestionIndex];
                questionCountEl.textContent = `å•é¡Œ ${currentQuestionIndex + 1} / ${currentQuestionData.length}`;
                optionsButtonsEl.innerHTML = ''; // Clear previous buttons
                feedbackAreaEl.style.display = 'none';
                nextQuestionButtonEl.style.display = 'none';
                detailsContainerEl.style.display = 'none';


                if (currentQuizType === 'suffix') {
                    suffixNoteDisplayEl.textContent = '';
                    if (questionData.suffix === "-ly (ä¾‹å¤–)") {
                        suffixDisplayEl.textContent = "-ly";
                        suffixNoteDisplayEl.textContent = "â€» ãŸã ã—ã€ã“ã‚ŒãŒå½¢å®¹è©ã«ãªã‚‹å ´åˆã®ä¾‹ã§ã™ã€‚";
                    } else {
                        suffixDisplayEl.textContent = questionData.suffix;
                    }
                    const posChoices = ["åè©", "å‹•è©", "å½¢å®¹è©", "å‰¯è©"];
                    posChoices.forEach(option => {
                        const button = document.createElement('button');
                        button.textContent = option;
                        button.onclick = () => handleAnswer(option, questionData);
                        optionsButtonsEl.appendChild(button);
                    });
                } else if (currentQuizType === 'conjPrep') {
                    let qText = "";
                    if (questionData.questionParts[0]) qText += questionData.questionParts[0];
                    qText += `<span class="blank">-------</span>`;
                    if (questionData.questionParts[1]) qText += questionData.questionParts[1];
                    conjPrepQuestionTextEl.innerHTML = qText;

                    Object.entries(questionData.options).forEach(([key, value]) => {
                        const button = document.createElement('button');
                        button.textContent = `(${key}) ${value}`;
                        button.onclick = () => {
                            // Remove 'selected' class from all buttons first
                            document.querySelectorAll('#options-buttons button').forEach(btn => btn.classList.remove('selected'));
                            // Add 'selected' class to the clicked button
                            button.classList.add('selected');
                            handleAnswer(key, questionData);
                        }
                        optionsButtonsEl.appendChild(button);
                    });
                }
            } else {
                displayResults();
            }
        }

        function handleAnswer(userChoice, questionData) {
            // Disable option buttons after an answer
            optionsButtonsEl.querySelectorAll('button').forEach(button => button.disabled = true);

            feedbackAreaEl.style.display = 'block';
            detailsContainerEl.style.display = 'block';
            let isCorrect = false;

            if (currentQuizType === 'suffix') {
                suffixDetailsEl.style.display = 'block';
                conjPrepDetailsEl.style.display = 'none';
                isCorrect = userChoice === questionData.pos;
                feedbackTextEl.textContent = isCorrect ?
                    `æ­£è§£ï¼ ğŸ‰ ã€Œ${questionData.suffix}ã€ã¯ä¸»ã« ${questionData.pos} ã®èªå°¾ã§ã™ã€‚` :
                    `æ®‹å¿µï¼ ã€Œ${questionData.suffix}ã€ã®ä¸»ãªå“è©ã¯ ${questionData.pos} ã§ã—ãŸã€‚(ã‚ãªãŸã®å›ç­”: ${userChoice})`;

                if (questionData.examples && questionData.examples.length > 0) {
                    exampleListEl.innerHTML = '';
                    questionData.examples.forEach(ex => {
                        const li = document.createElement('li');
                        li.textContent = ex;
                        exampleListEl.appendChild(li);
                    });
                    document.getElementById('examples-container').style.display = 'block';
                } else {
                    document.getElementById('examples-container').style.display = 'none';
                }
                if (questionData.note) {
                    noteTextEl.textContent = questionData.note;
                    noteContainerEl.style.display = 'block';
                } else {
                    noteContainerEl.style.display = 'none';
                }

            } else if (currentQuizType === 'conjPrep') {
                suffixDetailsEl.style.display = 'none';
                conjPrepDetailsEl.style.display = 'block';
                isCorrect = userChoice === questionData.answer;
                const userAnswerText = questionData.options[userChoice];
                feedbackTextEl.textContent = isCorrect ?
                    `æ­£è§£ï¼ ğŸ‰ æ­£ã—ã„é¸æŠè‚¢ã¯ (${questionData.answer}) ${questionData.correctWord} ã§ã™ã€‚` :
                    `æ®‹å¿µï¼ æ­£è§£ã¯ (${questionData.answer}) ${questionData.correctWord} ã§ã—ãŸã€‚(ã‚ãªãŸã®å›ç­”: (${userChoice}) ${userAnswerText})`;

                if (questionData.explanation) {
                    explanationTextEl.innerHTML = questionData.explanation.replace(/\n/g, '<br>'); // æ”¹è¡Œã‚’<br>ã«
                    explanationContainerEl.style.display = 'block';
                } else {
                    explanationContainerEl.style.display = 'none';
                }
            }

            if (isCorrect) {
                feedbackAreaEl.className = 'feedback correct';
                score++;
            } else {
                feedbackAreaEl.className = 'feedback incorrect';
                incorrectAnswers.push({
                    questionId: questionData.id,
                    questionText: currentQuizType === 'conjPrep' ? (questionData.questionParts.join(' ___ ') || `èªå°¾: ${questionData.suffix}`) : `èªå°¾: ${questionData.suffix}`,
                    userAnswer: userChoice,
                    correctAnswer: currentQuizType === 'conjPrep' ? questionData.answer : questionData.pos,
                    correctWord: questionData.correctWord || questionData.pos,
                    wordType: questionData.wordType || questionData.pos, // èªå°¾ã‚¯ã‚¤ã‚ºã¯posã‚’wordTypeã¨ã—ã¦æ‰±ã†
                    explanation: questionData.explanation || questionData.note || ""
                });
            }
            nextQuestionButtonEl.style.display = 'block';
        }

        function displayNextQuestion() {
             optionsButtonsEl.querySelectorAll('button').forEach(button => {
                button.disabled = false;
                button.classList.remove('selected'); // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            });
            currentQuestionIndex++;
            displayQuestion();
        }

        function displayResults() {
            quizAreaEl.style.display = 'none';
            resultsAreaEl.style.display = 'block';
            mistakeAnalysisAreaEl.style.display = 'block';


            finalScoreEl.textContent = `âœ… æ­£è§£æ•°: ${score}`;
            totalQuestionsEl.textContent = `ğŸ“– ç·å•é¡Œæ•°: ${currentQuestionData.length}`;
            const accuracyPercentage = currentQuestionData.length > 0 ? (score / currentQuestionData.length) * 100 : 0;
            accuracyEl.textContent = `ğŸ¯ æ­£ç­”ç‡: ${accuracyPercentage.toFixed(1)}%`;

            analyzeMistakes();
        }

        function analyzeMistakes() {
            mistakeListEl.innerHTML = '';
            if (incorrectAnswers.length === 0) {
                mistakeSummaryEl.textContent = 'ç´ æ™´ã‚‰ã—ã„ï¼å…¨å•æ­£è§£ã§ã™ã€‚';
                countermeasureCommentEl.textContent = 'ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
                mistakeListEl.style.display = 'none';
                return;
            }
            mistakeListEl.style.display = 'block';

            let prepMistakes = 0;
            let conjMistakes = 0;
            const wordTypeMistakes = {};

            incorrectAnswers.forEach(mistake => {
                const li = document.createElement('li');
                let qTextShort = mistake.questionText.length > 70 ? mistake.questionText.substring(0, 70) + "..." : mistake.questionText;
                li.innerHTML = `<span class="mistake-q">å•é¡Œ ${mistake.questionId}: ${qTextShort}</span><br>ã‚ãªãŸã®å›ç­”: ${mistake.userAnswer}, æ­£è§£: ${mistake.correctAnswer} (${mistake.correctWord})<br><span class="mistake-explanation">${mistake.explanation || ""}</span>`;
                mistakeListEl.appendChild(li);

                if (mistake.wordType === 'å‰ç½®è©') prepMistakes++;
                if (mistake.wordType === 'æ¥ç¶šè©') conjMistakes++;

                wordTypeMistakes[mistake.wordType] = (wordTypeMistakes[mistake.wordType] || 0) + 1;
            });

            let summaryText = `é–“é•ãˆãŸå•é¡Œæ•°: ${incorrectAnswers.length}å•ã€‚<br>`;
            let commonMistakeType = "";
            let maxMistakeCount = 0;

            for (const type in wordTypeMistakes) {
                summaryText += `${type}ã®é–“é•ã„: ${wordTypeMistakes[type]}å•ã€‚<br>`;
                if (wordTypeMistakes[type] > maxMistakeCount) {
                    maxMistakeCount = wordTypeMistakes[type];
                    commonMistakeType = type;
                }
            }
            mistakeSummaryEl.innerHTML = summaryText;

            let countermeasure = "é–“é•ãˆãŸå•é¡Œã®è§£èª¬ã‚’ã‚ˆãèª­ã¿ã€åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å•é¡Œã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚";
            if (currentQuizType === 'conjPrep') {
                if (prepMistakes > conjMistakes && prepMistakes > 0) {
                    countermeasure += "ç‰¹ã«å‰ç½®è©ã®ç”¨æ³•ï¼ˆæ„å‘³ã€ç¶šãèªå½¢ï¼‰ã®å¾©ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚";
                } else if (conjMistakes > prepMistakes && conjMistakes > 0) {
                    countermeasure += "ç‰¹ã«æ¥ç¶šè©ã®ç”¨æ³•ï¼ˆæ–‡ã¨æ–‡ã®ã¤ãªãæ–¹ã€æ„å‘³ã®åŒºåˆ¥ï¼‰ã®å¾©ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚";
                } else if (prepMistakes > 0 && prepMistakes === conjMistakes) {
                     countermeasure += "å‰ç½®è©ã¨æ¥ç¶šè©ã€ä¸¡æ–¹ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã‚’ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
                }
            } else if (currentQuizType === 'suffix') {
                 if (commonMistakeType) {
                    countermeasure += `ç‰¹ã«ã€Œ${commonMistakeType}ã€ã«ãªã‚Šã‚„ã™ã„èªå°¾ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é‡ç‚¹çš„ã«å¾©ç¿’ã—ã¾ã—ã‚‡ã†ã€‚`;
                }
            }
            countermeasure += "ãã‚Œãã‚Œã®å˜èªã‚„èªå°¾ãŒæŒã¤æ ¸ã¨ãªã‚‹æ„å‘³ã‚„æ©Ÿèƒ½ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚";
            countermeasureCommentEl.textContent = countermeasure;
        }

        nextQuestionButtonEl.addEventListener('click', displayNextQuestion);
        retryQuizButtonEl.addEventListener('click', startQuiz); // åŒã˜ã‚¯ã‚¤ã‚ºã‚’å†æŒ‘æˆ¦

        // åˆæœŸè¡¨ç¤º
        showQuizSelection();
    </script>
</body>
</html>
